# NextAuth èº«ä»½éªŒè¯ç³»ç»Ÿå®Œæ•´æµç¨‹è¯´æ˜

## ğŸ“‹ ç›®å½•ç»“æ„

```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ auth.ts              # NextAuth ä¸»é…ç½®æ–‡ä»¶ï¼ˆè®¤è¯æä¾›è€…ï¼‰
â”œâ”€â”€ auth.config.ts       # NextAuth é…ç½®ï¼ˆè·¯ç”±ä¿æŠ¤è§„åˆ™ï¼‰
â”œâ”€â”€ proxy.ts             # Next.js Middleware ä»£ç†ï¼ˆè·¯ç”±æ‹¦æˆªï¼‰
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â””â”€â”€ page.tsx     # ç™»å½•é¡µé¢
â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”œâ”€â”€ login-form.tsx        # ç™»å½•è¡¨å•ç»„ä»¶
â”‚   â”‚   â””â”€â”€ dashboard/
â”‚   â”‚       â””â”€â”€ sidenav.tsx       # ä¾§è¾¹æ ï¼ˆåŒ…å«ç™»å‡ºæŒ‰é’®ï¼‰
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ actions.ts   # æœåŠ¡å™¨æ“ä½œï¼ˆauthenticate å‡½æ•°ï¼‰
```

---

## ğŸ”„ å®Œæ•´è®¤è¯æµç¨‹

### é˜¶æ®µ 1ï¼šç”¨æˆ·è®¿é—®å—ä¿æŠ¤é¡µé¢

```
ç”¨æˆ·è®¿é—® /dashboard
    â†“
proxy.ts (Middleware) æ‹¦æˆªè¯·æ±‚
    â†“
æ£€æŸ¥ auth.config.ts ä¸­çš„ authorized å›è°ƒ
    â†“
ç”¨æˆ·æœªç™»å½•ï¼Ÿ
    â†“ æ˜¯
é‡å®šå‘åˆ° /login é¡µé¢
```

**ä»£ç ä½ç½®ï¼š`proxy.ts`**
```typescript
export default NextAuth(authConfig).auth;
```
- è¿™æ˜¯ Next.js Middlewareï¼Œä¼šåœ¨æ¯ä¸ªè¯·æ±‚ä¹‹å‰è¿è¡Œ
- è°ƒç”¨ `auth.config.ts` ä¸­çš„ `authorized` å›è°ƒå‡½æ•°

**ä»£ç ä½ç½®ï¼š`auth.config.ts`**
```typescript
callbacks: {
  authorized({ auth, request: { nextUrl } }) {
    const isLoggedIn = !!auth?.user;
    const isOnDashboard = nextUrl.pathname.startsWith('/dashboard');
    
    if (isOnDashboard) {
      if (isLoggedIn) return true;  // âœ… å·²ç™»å½•ï¼Œå…è®¸è®¿é—®
      return false;  // âŒ æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
    }
    // ... å…¶ä»–é€»è¾‘
  },
}
```

---

### é˜¶æ®µ 2ï¼šç”¨æˆ·å¡«å†™ç™»å½•è¡¨å•

**ä»£ç ä½ç½®ï¼š`app/ui/login-form.tsx`**

```typescript
<form action={formAction} className="space-y-3">
  <input name="email" type="email" />
  <input name="password" type="password" />
  <Button>Log in</Button>
</form>
```

- ç”¨æˆ·è¾“å…¥é‚®ç®±å’Œå¯†ç 
- ç‚¹å‡»"Log in"æŒ‰é’®
- è¡¨å•æäº¤åˆ° `authenticate` å‡½æ•°ï¼ˆæœåŠ¡å™¨æ“ä½œï¼‰

---

### é˜¶æ®µ 3ï¼šæœåŠ¡å™¨éªŒè¯å‡­æ®

**ä»£ç ä½ç½®ï¼š`app/lib/actions.ts`**

```typescript
export async function authenticate(prevState, formData) {
  try {
    await signIn('credentials', formData);
    // signIn æˆåŠŸä¼šè‡ªåŠ¨é‡å®šå‘
  } catch (error) {
    return 'Invalid credentials.';  // è¿”å›é”™è¯¯ä¿¡æ¯
  }
}
```

- `signIn` å‡½æ•°æ¥è‡ª `auth.ts`
- ä¼ é€’ `formData`ï¼ˆåŒ…å« email å’Œ passwordï¼‰
- å¦‚æœå¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯æ˜¾ç¤ºåœ¨è¡¨å•ä¸Š

---

### é˜¶æ®µ 4ï¼šNextAuth éªŒè¯ç”¨æˆ·

**ä»£ç ä½ç½®ï¼š`auth.ts`**

```typescript
export const { auth, signIn, signOut } = NextAuth({
  ...authConfig,
  providers: [
    Credentials({
      async authorize(credentials) {
        // 1. éªŒè¯è¾“å…¥æ ¼å¼
        const parsed = z.object({
          email: z.string().email(),
          password: z.string().min(6)
        }).safeParse(credentials);
        
        if (!parsed.success) return null;
        
        // 2. ä»æ•°æ®åº“æŸ¥æ‰¾ç”¨æˆ·
        const user = await getUser(email);
        if (!user) return null;
        
        // 3. éªŒè¯å¯†ç 
        const passwordsMatch = await bcrypt.compare(
          password, 
          user.password
        );
        
        if (passwordsMatch) return user;  // âœ… è¿”å›ç”¨æˆ·å¯¹è±¡
        return null;  // âŒ å¯†ç é”™è¯¯
      },
    }),
  ],
});
```

**è¯¦ç»†æ­¥éª¤ï¼š**

1. **æ ¼å¼éªŒè¯**ï¼šä½¿ç”¨ Zod éªŒè¯é‚®ç®±æ ¼å¼å’Œå¯†ç é•¿åº¦
2. **æŸ¥æ‰¾ç”¨æˆ·**ï¼šä» PostgreSQL æ•°æ®åº“æŸ¥è¯¢ç”¨æˆ·
   ```typescript
   const user = await sql`SELECT * FROM users WHERE email=${email}`;
   ```
3. **å¯†ç éªŒè¯**ï¼šä½¿ç”¨ bcrypt æ¯”è¾ƒæ˜æ–‡å¯†ç å’Œæ•°æ®åº“ä¸­çš„å“ˆå¸Œå¯†ç 
   ```typescript
   bcrypt.compare(password, user.password)
   ```
4. **è¿”å›ç»“æœ**ï¼š
   - æˆåŠŸï¼šè¿”å›ç”¨æˆ·å¯¹è±¡ï¼ŒNextAuth åˆ›å»ºä¼šè¯
   - å¤±è´¥ï¼šè¿”å› `null`ï¼Œè§¦å‘é”™è¯¯

---

### é˜¶æ®µ 5ï¼šåˆ›å»ºä¼šè¯å¹¶é‡å®šå‘

å¦‚æœ `authorize` è¿”å›ç”¨æˆ·å¯¹è±¡ï¼š

```
NextAuth åˆ›å»ºä¼šè¯ï¼ˆSessionï¼‰
    â†“
å°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨åŠ å¯†çš„ Cookie ä¸­
    â†“
é‡å®šå‘åˆ° callbackUrlï¼ˆé»˜è®¤ /dashboardï¼‰
    â†“
ç”¨æˆ·æˆåŠŸç™»å½•ï¼âœ…
```

---

### é˜¶æ®µ 6ï¼šç”¨æˆ·ç™»å‡º

**ä»£ç ä½ç½®ï¼š`app/ui/dashboard/sidenav.tsx`**

```typescript
<form action={async () => {
  'use server';
  await signOut();
}}>
  <button>Sign Out</button>
</form>
```

- ç‚¹å‡»"Sign Out"æŒ‰é’®
- è°ƒç”¨ `signOut()` å‡½æ•°ï¼ˆæ¥è‡ª `auth.ts`ï¼‰
- æ¸…é™¤ä¼šè¯ Cookie
- é‡å®šå‘åˆ°ç™»å½•é¡µ

---

## ğŸ” å…³é”®æ¦‚å¿µè§£é‡Š

### 1. NextAuth æ˜¯ä»€ä¹ˆï¼Ÿ

NextAuth æ˜¯ Next.js çš„èº«ä»½éªŒè¯åº“ï¼Œæä¾›ï¼š
- **ä¼šè¯ç®¡ç†**ï¼šè‡ªåŠ¨å¤„ç†ç™»å½•çŠ¶æ€
- **è·¯ç”±ä¿æŠ¤**ï¼šæ‹¦æˆªæœªæˆæƒè®¿é—®
- **å¤šç§è®¤è¯æ–¹å¼**ï¼šæ”¯æŒ Googleã€GitHubã€é‚®ç®±å¯†ç ç­‰

### 2. Credentials Providerï¼ˆå‡­æ®æä¾›è€…ï¼‰

è¿™æ˜¯"ç”¨æˆ·å+å¯†ç "çš„è®¤è¯æ–¹å¼ï¼š
- ç”¨æˆ·æä¾›é‚®ç®±å’Œå¯†ç 
- æœåŠ¡å™¨éªŒè¯ååˆ›å»ºä¼šè¯
- é€‚åˆä¼ ç»Ÿçš„ç™»å½•ç³»ç»Ÿ

### 3. Middlewareï¼ˆä¸­é—´ä»¶ï¼‰

`proxy.ts` æ˜¯ Next.js Middlewareï¼š
- **è¿è¡Œæ—¶æœº**ï¼šåœ¨æ¯ä¸ªè¯·æ±‚åˆ°è¾¾é¡µé¢ä¹‹å‰
- **ä½œç”¨**ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Œå†³å®šæ˜¯å¦å…è®¸è®¿é—®
- **åŒ¹é…è§„åˆ™**ï¼š`matcher` å®šä¹‰å“ªäº›è·¯å¾„éœ€è¦æ£€æŸ¥

### 4. Sessionï¼ˆä¼šè¯ï¼‰

ç™»å½•æˆåŠŸåï¼š
- NextAuth åˆ›å»ºåŠ å¯†çš„ä¼šè¯ Cookie
- åŒ…å«ç”¨æˆ·ä¿¡æ¯ï¼ˆIDã€é‚®ç®±ç­‰ï¼‰
- æ¯æ¬¡è¯·æ±‚è‡ªåŠ¨éªŒè¯ Cookie
- ç™»å‡ºæ—¶æ¸…é™¤ Cookie

---

## ğŸ¯ æœ€ç»ˆå®ç°çš„æ•ˆæœ

### âœ… å·²å®ç°çš„åŠŸèƒ½

1. **è·¯ç”±ä¿æŠ¤**
   - æœªç™»å½•ç”¨æˆ·è®¿é—® `/dashboard` è‡ªåŠ¨é‡å®šå‘åˆ° `/login`
   - å·²ç™»å½•ç”¨æˆ·è®¿é—® `/login` è‡ªåŠ¨é‡å®šå‘åˆ° `/dashboard`

2. **ç™»å½•åŠŸèƒ½**
   - ç”¨æˆ·è¾“å…¥é‚®ç®±å’Œå¯†ç 
   - éªŒè¯æ•°æ®åº“ä¸­çš„ç”¨æˆ·å‡­æ®
   - å¯†ç ä½¿ç”¨ bcrypt åŠ å¯†å­˜å‚¨å’ŒéªŒè¯

3. **ä¼šè¯ç®¡ç†**
   - ç™»å½•åä¿æŒç™»å½•çŠ¶æ€
   - åˆ·æ–°é¡µé¢ä¸ä¼šé€€å‡ºç™»å½•
   - å¯ä»¥å®‰å…¨åœ°ç™»å‡º

4. **é”™è¯¯å¤„ç†**
   - æ˜¾ç¤º"Invalid credentials"é”™è¯¯ä¿¡æ¯
   - è¡¨å•éªŒè¯ï¼ˆé‚®ç®±æ ¼å¼ã€å¯†ç é•¿åº¦ï¼‰

---

## ğŸ”§ æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è®¿é—®   â”‚
â”‚  /dashboard â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  proxy.ts   â”‚  â† Middleware æ‹¦æˆª
â”‚ (Middleware)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚auth.config.tsâ”‚  â† æ£€æŸ¥ authorized å›è°ƒ
â”‚  callbacks   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   æœªç™»å½•ï¼Ÿâ”€â”€â”€æ˜¯â”€â”€â”€â–º é‡å®šå‘åˆ° /login
       â”‚
      å¦
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ˜¾ç¤ºé¡µé¢   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç™»å½•æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç™»å½•è¡¨å•æäº¤ â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚authenticate â”‚  â† app/lib/actions.ts
â”‚  å‡½æ•°       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  signIn()   â”‚  â† auth.ts
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Credentials â”‚  â† éªŒè¯æä¾›è€…
â”‚  authorize  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â–º æŸ¥è¯¢æ•°æ®åº“ (getUser)
       â”‚
       â”œâ”€â–º éªŒè¯å¯†ç  (bcrypt.compare)
       â”‚
       â–¼
   æˆåŠŸï¼Ÿâ”€â”€â”€å¦â”€â”€â”€â–º è¿”å›é”™è¯¯
       â”‚
      æ˜¯
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ›å»ºä¼šè¯    â”‚
â”‚ (Session)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é‡å®šå‘åˆ°    â”‚
â”‚ /dashboard  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. auth.ts ä¸­çš„æ•°æ®åº“è¿æ¥é—®é¢˜

`auth.ts` ç¬¬ 9 è¡Œä¹Ÿæœ‰åŒæ ·çš„é—®é¢˜ï¼š
```typescript
const sql = postgres(process.env.POSTGRES_URL!, { ssl: 'require' });
```

è¿™ä¼šåœ¨æ„å»ºæ—¶å°è¯•è¿æ¥æ•°æ®åº“ã€‚å»ºè®®ä¹Ÿæ”¹ä¸ºå»¶è¿Ÿåˆå§‹åŒ–ã€‚

### 2. ç¯å¢ƒå˜é‡

ç¡®ä¿è®¾ç½®äº†ï¼š
- `POSTGRES_URL`ï¼šæ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
- `AUTH_SECRET`ï¼šNextAuth åŠ å¯†å¯†é’¥ï¼ˆç”¨äºåŠ å¯†ä¼šè¯ï¼‰

### 3. å¯†ç å®‰å…¨

- å¯†ç ä½¿ç”¨ bcrypt å“ˆå¸Œå­˜å‚¨
- æ°¸è¿œä¸è¦å­˜å‚¨æ˜æ–‡å¯†ç 
- ä½¿ç”¨ HTTPS ä¼ è¾“å¯†ç 

---

## ğŸ“š æ€»ç»“

ä½ çš„èº«ä»½éªŒè¯ç³»ç»Ÿå®ç°äº†ï¼š

1. âœ… **è‡ªåŠ¨è·¯ç”±ä¿æŠ¤** - æœªç™»å½•ç”¨æˆ·æ— æ³•è®¿é—® dashboard
2. âœ… **å®‰å…¨çš„ç™»å½•æµç¨‹** - é‚®ç®±å¯†ç éªŒè¯ï¼Œå¯†ç åŠ å¯†
3. âœ… **ä¼šè¯ç®¡ç†** - è‡ªåŠ¨ç»´æŠ¤ç™»å½•çŠ¶æ€
4. âœ… **ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º** - æ˜¾ç¤ºç™»å½•é”™è¯¯ä¿¡æ¯

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€ç”Ÿäº§å°±ç»ªçš„èº«ä»½éªŒè¯ç³»ç»Ÿï¼

